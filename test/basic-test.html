<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
    <script src="../../../mocha/mocha.js"></script>
    <script src="../../../chai/chai.js"></script>
    <script src="../../../wct-mocha/wct-mocha.js"></script>
    <script src="../../../sinon/pkg/sinon.js"></script>

  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <content-type-selector></content-type-selector>
      </template>
    </test-fixture>

    <test-fixture id="Selected">
      <template>
        <content-type-selector selected="1"></content-type-selector>
      </template>
    </test-fixture>

    <test-fixture id="extended">
      <template>
        <content-type-selector>
          <paper-item slot="item" data-type="application/zip">Zip file</paper-item>
        </content-type-selector>
      </template>
    </test-fixture>

    <script type="module">
    import '../content-type-selector.js';
    suite('basic', () => {
      let element;
      const CT_VALUE = 'application/json';

      setup((done) => {
        element = fixture('basic');
        flush(() => done());
      });

      test('Fires content type change event', () => {
        const dropdown = element.shadowRoot.querySelector('paper-listbox');
        const spy = sinon.stub();
        element.addEventListener('content-type-changed', spy);
        dropdown.selected = 1;
        assert.isTrue(spy.called);
      });

      test('Handles content-type-changed event', () => {
        const init = {
          detail: {
            value: CT_VALUE
          },
          bubbles: true,
          cancelable: true
        };
        const e = new CustomEvent('content-type-changed', init);
        document.dispatchEvent(e);
        assert.equal(element.contentType, CT_VALUE);
      });

      test('Selected complex content types', () => {
        element.contentType = 'multipart/form-data; boundary=something';
        assert.isDefined(element.selected);
      });

      test('Selection changes content type value', () => {
        element.selected = 1;
        assert.equal(element.contentType, 'application/xml');
      });
    });

    suite('_contentTypeChanged()', () => {
      let element;
      setup((done) => {
        element = fixture('Selected');
        flush(() => done());
      });

      test('Resets selection when no argument', () => {
        element._contentTypeChanged();
        assert.isUndefined(element.selected);
      });

      test('Selects content type', () => {
        element._contentTypeChanged('application/json');
        assert.equal(element.selected, 0);
      });

      test('Selects content type with charset', () => {
        element._contentTypeChanged('application/json; charset=utf8');
        assert.equal(element.selected, 0);
      });

      test('Resets selection when not supported', () => {
        element._contentTypeChanged('not/supported');
        assert.isUndefined(element.selected);
      });
    });

    suite('extended', () => {
      let element;
      const CT_VALUE = 'application/zip';

      setup((done) => {
        element = fixture('extended');
        flush(() => done());
      });

      test('Selectes extended option', () => {
        element.contentType = CT_VALUE;
        assert.equal(element.selected, 13);
      });
    });
    </script>

  </body>
</html>
